{{ 'product-how-to-use.css' | asset_url | stylesheet_tag }}

{%- assign how_to_use = product.metafields.custom.how_to_use -%}

{%- if how_to_use and how_to_use.steps.count > 0 -%}
<section class="product-how-to-use-section" id="section-{{ section.id }}">
  <div class="product-how-to-use__container">
    {%- comment -%} Heading {%- endcomment -%}
    <div class="product-how-to-use__heading">
      <h2 class="product-how-to-use__title">{{ how_to_use.title | default: 'How To Use Rejuvia' }}</h2>
      <p class="product-how-to-use__subtitle">{{ how_to_use.subtitle | default: 'Sleep made simple. Just spray, relax, and drift off.' }}</p>
    </div>

    {%- comment -%} Content: Image + Steps {%- endcomment -%}
    <div class="product-how-to-use__content">
      {%- comment -%} Image Container {%- endcomment -%}
      {%- if how_to_use.steps.first.file -%}
        <div class="product-how-to-use__image-wrapper">
          <div class="product-how-to-use__image-container">
            {{ how_to_use.steps.first.file | image_url: width: 1200 | image_tag:
              loading: 'lazy',
              widths: '375, 550, 750, 1100, 1500',
              class: 'product-how-to-use__image',
              alt: how_to_use.steps.first.step_title
            }}
          </div>
          <div class="product-how-to-use__decorative-icon" aria-hidden="true">
            {%- if how_to_use.steps.first.svg_icon -%}
              {{ how_to_use.steps.first.svg_icon }}
            {%- endif -%}
          </div>
        </div>
      {%- endif -%}

      {%- comment -%} Steps Container {%- endcomment -%}
      <div class="product-how-to-use__steps">
        {%- for step in how_to_use.steps -%}
          {%- assign step_index = forloop.index -%}
          <div class="product-how-to-use__step {% if forloop.first %}is-active{% endif %}"
               data-step="{{ step_index }}">

            {%- comment -%} Step Header (always visible) {%- endcomment -%}
            <button
              class="product-how-to-use__step-header"
              type="button"
              aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
              aria-controls="step-content-{{ section.id }}-{{ step_index }}"
              data-step-toggle>

              <span class="product-how-to-use__step-title">
                Step {{ step_index }}:
                {%- if step.step_title -%}
                  <span class="product-how-to-use__step-name">{{ step.step_title }}</span>
                {%- endif -%}
              </span>

              {%- if step.svg_icon and step.left_side_svg -%}
                <span class="product-how-to-use__step-icon" aria-hidden="true">
                  {{ step.svg_icon }}
                </span>
              {%- endif -%}
            </button>

            {%- comment -%} Step Content (accordion panel) {%- endcomment -%}
            <div
              class="product-how-to-use__step-content"
              id="step-content-{{ section.id }}-{{ step_index }}"
              {% unless forloop.first %}hidden{% endunless %}>

              {%- if step.description -%}
                <div class="product-how-to-use__step-description">
                  {{ step.description | newline_to_br }}
                </div>
              {%- endif -%}

              {%- comment -%} Tips Section {%- endcomment -%}
              {%- if step.first_tip_title -%}
                <div class="product-how-to-use__divider"></div>

                <div class="product-how-to-use__tips {% if step.second_tip_title %}product-how-to-use__tips--two-column{% endif %}">
                  {%- comment -%} First Tip {%- endcomment -%}
                  <div class="product-how-to-use__tip">
                    <div class="product-how-to-use__tip-label">
                      {%- if step.first_tip_icon_svg -%}
                        <span class="product-how-to-use__tip-icon" aria-hidden="true">
                          {{ step.first_tip_icon_svg }}
                        </span>
                      {%- endif -%}
                      <span class="product-how-to-use__tip-title">{{ step.first_tip_title }}</span>
                    </div>
                    {%- if step.first_tip_description -%}
                      <p class="product-how-to-use__tip-description">{{ step.first_tip_description }}</p>
                    {%- endif -%}
                  </div>

                  {%- comment -%} Second Tip (if present) {%- endcomment -%}
                  {%- if step.second_tip_title -%}
                    <div class="product-how-to-use__tip">
                      <div class="product-how-to-use__tip-label">
                        {%- if step.second_tip_icon_svg -%}
                          <span class="product-how-to-use__tip-icon" aria-hidden="true">
                            {{ step.second_tip_icon_svg }}
                          </span>
                        {%- endif -%}
                        <span class="product-how-to-use__tip-title">{{ step.second_tip_title }}</span>
                      </div>
                      {%- if step.second_tip_description -%}
                        <p class="product-how-to-use__tip-description">{{ step.second_tip_description }}</p>
                      {%- endif -%}
                    </div>
                  {%- endif -%}
                </div>
              {%- endif -%}
            </div>
          </div>
        {%- endfor -%}
      </div>
    </div>
  </div>
</section>

<script>
  (function() {
    const section = document.getElementById('section-{{ section.id }}');
    if (!section) return;

    const stepToggles = section.querySelectorAll('[data-step-toggle]');

    stepToggles.forEach(toggle => {
      toggle.addEventListener('click', function() {
        const step = this.closest('.product-how-to-use__step');
        const content = this.nextElementSibling;
        const isExpanded = this.getAttribute('aria-expanded') === 'true';

        // Close all other steps
        stepToggles.forEach(otherToggle => {
          if (otherToggle !== this) {
            const otherStep = otherToggle.closest('.product-how-to-use__step');
            const otherContent = otherToggle.nextElementSibling;

            otherStep.classList.remove('is-active');
            otherToggle.setAttribute('aria-expanded', 'false');
            otherContent.setAttribute('hidden', '');
          }
        });

        // Toggle current step
        if (!isExpanded) {
          step.classList.add('is-active');
          this.setAttribute('aria-expanded', 'true');
          content.removeAttribute('hidden');
        }
      });
    });
  })();
</script>
{%- endif -%}

{% schema %}
{
  "name": "Product How To Use",
  "tag": "section",
  "class": "product-how-to-use",
  "settings": [
    {
      "type": "paragraph",
      "content": "This section displays the 'How To Use' instructions from the product's custom.how_to_use metafield. To edit the content, go to the product page in the admin and edit the 'How To Use' metafield. The section will be hidden if no steps are defined."
    },
    {
      "type": "paragraph",
      "content": "**Metafield structure:** custom.how_to_use (metaobject) contains: Title, Subtitle, and Steps (list of step metaobjects). Each step includes: step_title, description, image, svg_icon, left_side_svg, and optional tips with icons."
    }
  ],
  "presets": [
    {
      "name": "Product How To Use"
    }
  ],
  "templates": ["product"]
}
{% endschema %}
